// ─── DMHicc Prisma Schema ────────────────────────────────────────────────────
// All models mirror the global.d.ts type contracts exactly.
// Phase 14: production PostgreSQL via Prisma Accelerate.

generator client {
    provider = "prisma-client-js"
    output = "./generated/client"
}

datasource db {
    provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────────────────────────

enum UserRole {
    USER
    TEAM_LEAD
    ADMIN
    SUPER_ADMIN
}

enum CampaignStatus {
    DRAFT
    ACTIVE
    PAUSED
    COMPLETED
    ARCHIVED
}

enum CampaignMediaType {
    IMAGE
    VIDEO
    LINK
    TEXT
}

enum GoalType {
    SHARES
    CLICKS
    REFERRALS
    DONATIONS
    PARTICIPANTS
}

enum LinkEventType {
    VIEW
    CLICK
    SHARE
    CONVERSION
    REFERRAL
}

enum PointType {
    IMPACT
    CONSISTENCY
    LEADERSHIP
    RELIABILITY
}

enum DonationStatus {
    PENDING
    COMPLETED
    FAILED
    REFUNDED
    RECEIVED
    VERIFIED
    REJECTED
}

enum TrustFlag {
    DUPLICATE_ACTIVITY
    ABNORMAL_CLICKS
    SUSPICIOUS_DEVICE
    RATE_LIMITED
}

enum SocialPlatform {
    FACEBOOK
    INSTAGRAM
    TWITTER_X
    TIKTOK
    YOUTUBE
    WHATSAPP
    SNAPCHAT
}

enum ViewProofStatus {
    PENDING
    APPROVED
    REJECTED
}

enum CampaignAuditEventType {
    CREATED
    STATUS_CHANGED
    FIELDS_UPDATED
    PARTICIPANT_JOINED
    DONATION_RECEIVED
    GOAL_REACHED
    ENDED
}

enum NotificationType {
    CAMPAIGN_UPDATE
    REFERRAL_JOINED
    POINTS_EARNED
    TRUST_FLAG
    SYSTEM
}

// ─── Models ──────────────────────────────────────────────────────────────────

model User {
    id              String           @id @default(cuid())
    email           String           @unique
    passwordHash    String
    firstName       String
    lastName        String
    role            UserRole         @default(USER)
    profilePicture  String?
    whatsappNumber  String?
    teamId          String?
    trustScore      Int              @default(100)
    isActive        Boolean          @default(true)
    weaponsOfChoice SocialPlatform[]
    createdAt       DateTime         @default(now())
    updatedAt       DateTime         @updatedAt

    // Relations
    team               Team?                   @relation(fields: [teamId], references: [id], onDelete: SetNull)
    createdCampaigns   Campaign[]              @relation("CampaignCreator")
    participations     CampaignParticipation[]
    smartLinks         SmartLink[]
    referralsGiven     Referral[]              @relation("ReferralInviter")
    referralsReceived  Referral[]              @relation("ReferralInvitee")
    donations          Donation[]              @relation("DonationUser")
    verifiedDonations  Donation[]              @relation("DonationVerifier")
    pointsLedger       PointsLedgerEntry[]
    leaderboardEntries LeaderboardSnapshot[]
    trustScoreRecord   TrustScore?
    notifications      AppNotification[]
    viewProofs         ViewProof[]             @relation("ViewProofUser")
    reviewedProofs     ViewProof[]             @relation("ViewProofReviewer")
    teamInviteLinks    TeamInviteLink[]
    auditEvents        CampaignAuditEvent[]

    @@index([email])
    @@index([role])
    @@index([teamId])
    @@index([isActive])
}

model Campaign {
    id               String             @id @default(cuid())
    title            String
    description      String             @db.Text
    content          String             @db.Text
    media            Json               @default("[]") // CampaignMedia[]
    mediaType        CampaignMediaType?
    mediaUrl         String?
    thumbnailUrl     String?
    ctaText          String?
    ctaUrl           String?
    createdById      String
    status           CampaignStatus     @default(DRAFT)
    goalType         GoalType?
    goalTarget       Int?
    goalCurrent      Int?               @default(0)
    startDate        DateTime?
    endDate          DateTime?
    targetAudience   String[]           @default([])
    publishedAt      DateTime?
    metaTitle        String?
    metaDescription  String?            @db.Text
    metaImage        String?
    viewCount        Int                @default(0)
    clickCount       Int                @default(0)
    shareCount       Int                @default(0)
    likeCount        Int?               @default(0)
    participantCount Int?               @default(0)
    isMegaCampaign   Boolean?           @default(false)
    parentCampaignId String?
    bankAccountIds   String[]           @default([])
    createdAt        DateTime           @default(now())
    updatedAt        DateTime           @updatedAt

    // Relations
    creator        User                    @relation("CampaignCreator", fields: [createdById], references: [id])
    parentCampaign Campaign?               @relation("SubCampaigns", fields: [parentCampaignId], references: [id], onDelete: SetNull)
    subCampaigns   Campaign[]              @relation("SubCampaigns")
    participations CampaignParticipation[]
    smartLinks     SmartLink[]
    referrals      Referral[]
    donations      Donation[]
    pointsLedger   PointsLedgerEntry[]
    leaderboard    LeaderboardSnapshot[]
    viewProofs     ViewProof[]
    auditEvents    CampaignAuditEvent[]

    @@index([status])
    @@index([createdById])
    @@index([createdAt])
    @@index([parentCampaignId])
}

model CampaignParticipation {
    id          String   @id @default(cuid())
    userId      String
    campaignId  String
    joinedAt    DateTime @default(now())
    smartLinkId String?

    // Relations
    user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

    @@unique([userId, campaignId])
    @@index([userId])
    @@index([campaignId])
}

model SmartLink {
    id               String    @id @default(cuid())
    slug             String    @unique
    userId           String
    campaignId       String
    originalUrl      String
    clickCount       Int       @default(0)
    uniqueClickCount Int       @default(0)
    conversionCount  Int       @default(0)
    isActive         Boolean   @default(true)
    isExpired        Boolean   @default(false)
    expiresAt        DateTime?
    createdAt        DateTime  @default(now())
    updatedAt        DateTime  @updatedAt

    // Relations
    user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    campaign   Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
    linkEvents LinkEvent[]

    @@unique([userId, campaignId])
    @@index([slug])
    @@index([userId])
    @@index([campaignId])
}

model LinkEvent {
    id          String         @id @default(cuid())
    linkId      String
    smartLinkId String?
    slug        String?
    eventType   LinkEventType
    type        LinkEventType?
    userId      String?
    ipAddress   String?
    ipHash      String?
    userAgent   String?
    referrer    String?
    referer     String?
    country     String?
    createdAt   DateTime       @default(now())

    // Relations
    smartLink SmartLink @relation(fields: [linkId], references: [id], onDelete: Cascade)

    @@index([linkId])
    @@index([eventType])
    @@index([createdAt])
    @@index([userId])
}

model Referral {
    id         String   @id @default(cuid())
    inviterId  String
    inviteeId  String
    campaignId String
    slug       String
    createdAt  DateTime @default(now())

    // Relations
    inviter  User     @relation("ReferralInviter", fields: [inviterId], references: [id], onDelete: Cascade)
    invitee  User     @relation("ReferralInvitee", fields: [inviteeId], references: [id], onDelete: Cascade)
    campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

    @@unique([inviteeId, slug])
    @@index([inviterId])
    @@index([inviteeId])
    @@index([campaignId])
}

model Donation {
    id                 String         @id @default(cuid())
    userId             String
    campaignId         String
    amount             Decimal        @db.Decimal(12, 2)
    currency           String         @default("NGN")
    status             DonationStatus @default(PENDING)
    reference          String         @unique
    bankAccountId      String?
    proofScreenshotUrl String?
    verifiedById       String?
    verifiedAt         DateTime?
    notes              String?        @db.Text
    createdAt          DateTime       @default(now())
    updatedAt          DateTime       @updatedAt

    // Relations
    user       User     @relation("DonationUser", fields: [userId], references: [id], onDelete: Cascade)
    campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
    verifiedBy User?    @relation("DonationVerifier", fields: [verifiedById], references: [id], onDelete: SetNull)

    @@index([userId])
    @@index([campaignId])
    @@index([status])
    @@index([createdAt])
}

model PointsLedgerEntry {
    id          String    @id @default(cuid())
    userId      String
    campaignId  String?
    type        PointType
    value       Int
    description String
    referenceId String?
    createdAt   DateTime  @default(now())

    // Relations
    user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    campaign Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

    @@index([userId])
    @@index([campaignId])
    @@index([type])
    @@index([createdAt])
}

model LeaderboardSnapshot {
    id         String   @id @default(cuid())
    userId     String
    campaignId String?
    period     String
    rank       Int
    score      Int
    createdAt  DateTime @default(now())

    // Relations
    user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    campaign Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

    @@index([userId])
    @@index([campaignId])
    @@index([period])
    @@index([createdAt])
}

model TrustScore {
    id             String      @id @default(cuid())
    userId         String      @unique
    score          Int         @default(100)
    flags          TrustFlag[]
    lastReviewedAt DateTime?
    updatedAt      DateTime    @updatedAt

    // Relations
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([score])
}

model AppNotification {
    id        String           @id @default(cuid())
    userId    String
    type      NotificationType
    title     String
    body      String           @db.Text
    isRead    Boolean          @default(false)
    link      String?
    createdAt DateTime         @default(now())

    // Relations
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([isRead])
    @@index([createdAt])
}

model ViewProof {
    id            String          @id @default(cuid())
    userId        String
    campaignId    String
    smartLinkId   String
    platform      SocialPlatform
    screenshotUrl String
    status        ViewProofStatus @default(PENDING)
    reviewedById  String?
    reviewedAt    DateTime?
    notes         String?         @db.Text
    createdAt     DateTime        @default(now())
    updatedAt     DateTime        @updatedAt

    // Relations
    user       User     @relation("ViewProofUser", fields: [userId], references: [id], onDelete: Cascade)
    reviewedBy User?    @relation("ViewProofReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)
    campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([campaignId])
    @@index([status])
    @@index([createdAt])
}

model Group {
    id          String   @id @default(cuid())
    name        String
    description String?  @db.Text
    maxTeams    Int      @default(4)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    // Relations
    teams Team[]

    @@index([name])
}

model Team {
    id         String   @id @default(cuid())
    name       String
    groupId    String
    teamLeadId String?
    maxMembers Int      @default(10)
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    // Relations
    group           Group            @relation(fields: [groupId], references: [id], onDelete: Cascade)
    members         User[]
    teamInviteLinks TeamInviteLink[]

    @@index([groupId])
    @@index([teamLeadId])
    @@index([name])
}

model TeamInviteLink {
    id          String    @id @default(cuid())
    token       String    @unique
    teamId      String
    targetRole  String // "MEMBER" | "TEAM_LEAD"
    createdById String
    usedCount   Int       @default(0)
    maxUses     Int       @default(50)
    expiresAt   DateTime?
    isActive    Boolean   @default(true)
    createdAt   DateTime  @default(now())

    // Relations
    team      Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
    createdBy User @relation(fields: [createdById], references: [id], onDelete: Cascade)

    @@index([token])
    @@index([teamId])
}

model CampaignAuditEvent {
    id         String                 @id @default(cuid())
    campaignId String
    actorId    String
    actorRole  String
    eventType  CampaignAuditEventType
    before     Json?
    after      Json?
    note       String?                @db.Text
    createdAt  DateTime               @default(now())

    // Relations
    campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
    actor    User     @relation(fields: [actorId], references: [id], onDelete: Cascade)

    @@index([campaignId])
    @@index([actorId])
    @@index([createdAt])
}
